# 交易生态系统

市场数据发布器可以使用TCP或UDP来发布市场数据，但考虑到市场数据更新的大量性，UDP多播是首选的网络层协议。
市场数据发布器还负责在发布更新之前，将撮合引擎的内部格式转换为市场数据格式。

## 交易生态系统的组件

### 订单网关服务器

负责接受市场参与者的连接，以便他们可以发送订单请求，并在各自的订单有更新时收到通知

订单网关服务器还负责在撮合引擎格式和订单网关消息协议之间进行消息转换。

订单网关服务器使用的网络协议始终是TCP，以确保消息按顺序传递和可靠性。

### 市场数据消费者

这个组件负责订阅市场数据发布器设置的UDP流或TCP服务器，接收市场数据更新，并将市场数据协议解码为交易引擎其他部分使用的内部格式。

### 订单网关编码器和解码器客户端

与交易平台的订单网关基础设施建立并维护TCP连接

负责将策略订单请求编码为正确的交易平台订单消息协议，并将交易平台的响应解码为交易引擎使用的内部格式。

### 市场参与者系统中的交易引擎

负责接收来自市场数据消费者组件的标准化市场数据更新

它还会构建完整的限价订单簿以反映市场状态，或者至少构建一个根据交易策略需求简化的订单簿变体

这个组件使用订单网关客户端组件与交易平台进行通信。


## 撮合系统 => 交易所

我们假设市场参与者只发送限价订单（limit orders），并指明订单方向、数量和价格。限价订单是指只能以等于或优于市场参与者指定价格执行的订单。

撮合引擎执行着最为关键的任务，即正确、公平地对不同市场参与者的订单进行匹配。
这里所说的公平，是指先到达交易所的订单先进行处理，这种先进先出（FIFO，First In, First Out ）的排序由订单网关基础设施处理。

价格优先，时间优先，对于方向和价格相同的订单，会根据发送时间按先进先出的顺序排列
（大额订单在先进先出队列中的位置如何，它们都能从主动订单中获得更多的成交份额，先进先出的匹配算法）

价格优先怎么控制。

### 交易所订单簿

限价订单簿包含所有市场参与者针对单一交易工具发出的被动限价订单

| 买入订单 | 卖出订单 | 
| --- | --- | 
| 客户A 订单ID 1 买入20 @ 10.90 | 客户B 订单ID 5 卖出10 @ 11.00 | 
| 客户A 订单ID 8 买入10 @ 10.90 | 客户C 订单ID 6 卖出5 @ 11.00 | 
| 客户A 订单ID 2 买入10 @ 10.80 | 客户B 订单ID 7 卖出5 @ 11.10 | 
| 客户B 订单ID 3 买入5 @ 10.80 | 客户B 订单ID 9 卖出10 @ 11.20 | 
| 客户C 订单ID 4 买入100 @ 10.70 | - | 

- 当订单修改为减少数量时，订单在队列中的优先级或位置不变。
- 当订单修改为增加数量或修改价格时，其效果相当于取消原订单并发送一个新价格和数量的订单（即会为其分配一个新的优先级）。

### 设计撮合引擎

撮合引擎、市场数据发布器和订单网关服务器将各自独立运行在不同线程中，这也为使用无锁队列提供了绝佳场景？

即使撮合引擎处于忙碌状态，订单网关服务器也必须与所有市场参与者保持连接；
假设市场数据发布器正忙于通过网络发送市场数据，我们也不希望撮合引擎或订单网关服务器因此而减速

=>  忽略

### 通过市场传达市场事件

这些消息用于通知市场参与者市场和 / 或撮合引擎的状态变化。

通常，市场会经历诸如交易关闭、开盘前（常规交易时段前的市场状态）、开盘（市场从开盘前状态过渡到交易状态时）和交易（常规交易时段）等状态。（这些也可以我们通知）

#### 数据协议编码器

市场数据编码器接收反映订单簿变化的市场数据更新，并将其转换为带有一些附加信息的公开市场数据消息格式

该组件还将增量市场数据更新发布到为增量流配置的UDP多播流中？

编码后的市场数据更新也会发布到快照合成器组件


市场数据消费者可能会因网络拥塞、硬件或软件速度慢等原因丢弃UDP数据包。发生这种情况时，交易客户端维护的订单簿就会出现错误，
因为他们可能错过了与新订单添加、订单修改或取消等对应的更新。这就是快照多播流要解决的问题

